---
title: "Using the app "
output: 
  bookdown::html_document2:
      base_format: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Using the app }
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
bibliography: references.bib
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  echo = FALSE,
  message = FALSE, 
  warning = FALSE,
  comment = "#>"
)
```

```{r setup}
library(CaribouDemographyBasicApp)
lang <- "en"
```

```{=html}
<!--- A vignette to outline the uses of the app including: General description of the interface Uncertainty
How to update data
Technical write up on how models are fit that refers back to bboutools/caribouMetrics --->
```

# Using the app

The “Boreal Caribou Demographic Projection Explorer App” is designed to provide a user-friendly interface for exploring caribou demographic data and metrics. The app allows users to visualize and analyze caribou population dynamics, including survival rates, recruitment, and population trends.

This app is designed to use existing methods developed in the <a href="https://poissonconsulting.github.io/bboutools/" target="_blank">bboutools</a> and <a href="https://landscitech.github.io/caribouMetrics/" target="_blank">caribouMetrics</a> R packages to estimate demographic rates and project future population growth while incorporating the uncertainty associated with these estimates. The demographic rates presented in the app are derived from survival and recruitment surveys. These are both estimated from field surveys of collared caribou [@nbckc2021; @nbckc2022]. Typically, female caribou (cows) are captured in the late winter and fitted with collars that transmit data on their location and survival. Recruitment is estimated by counting the number of calves per cow in groups containing collared caribou. Recruitment surveys are typically done \~ 9 months after calving so it represents the number of calves that were born and survived until the survey. This survey data is used to estimate the **% female survival** and the number of **calves per 100 cows**. These demographic rates can be combined in a simple recruitment-mortality population model [@hatter1991; @hatter2020] to project population growth over time.

## Typical app usage

Typically the app will be made available to users with caribou data for the populations of interest already loaded in the app. Users can then explore the demographic rates and projections for these populations.

-   The **Welcome** tab provides an overview of the app and its functionality. On the sidebar, users can choose the language (French or English) and select options used in the **Projections** tab.
-   Users can navigate to the **Survey data** tab to view the data used to calculate demographic rates, including survival and recruitment rates. There are 5 sections in this tab beginning with a description of the data written by the data providers and a disclaimer. The data description section can be expanded to full screen for easier reading by clicking on the expand button at the lower right side of the window.
-   The next section contains graphs showing the survey data that is used to determine the demographic rate estimates. The survival graphs show how many caribou were collared and of these how many died, while the recruitment graphs show the number of caribou in each category that were counted in the survey. You can switch between the survival and recruitment data graphs by clicking the button in the top right of the "Survey data summary" section.
-   The next section shows the demographic rates estimated by the model for each population and year. The point shows the median value and the line shows the range of values that are plausible. For example, if the median estimated survival is 80% and the range is between 76% and 86%, it means that the midpoint of all the survival estimates was 80% and that 95% of all the survival estimates were between 76% and 86%. See section \@ref(technical-details) for more details.
-   Finally, the "Data summary" section includes a table showing the initial population used to start the projections, the year the initial population was recorded, and the number of years of data available for survival and recruitment.

```{r out.width=600}
# knitr::include_graphics(here::here("inst", "www", "survivalSummary.png" ))
# knitr::include_graphics(here::here("inst", "www", "recruitmentSummary.png" ))
knitr::include_graphics(here::here("vignettes/snapshots", paste0("input_data_", lang, ".png" )))
```

-   The **Projections** tab is where users can visualize population growth over time based on the current demographic rates and explore alternative scenarios. In the sidebar users can select the caribou population, and the number of years for the simulation. To update the results shown in the graph click “Run model”. Note that results will not be shown for populations with only one year of recruitment or survival data because one year of data is insufficient for making reliable predictions.
-   The first graph shows the projected adult female population size over time. The darker line shows the estimated population size if we ignore uncertainty about demographic rates and variation between years. The paler lines show a variety of plausible outcomes given the uncertainty about demographic rates and the observed variation among years. Only the female population is shown because it is assumed that the number of females is what limits population growth. The population is considered stable if the line is flat or sloped upwards and is declining if the line slopes downward. If some plausible trajectories are increasing while others are decreasing there is uncertainty about whether the population is declining or not. Additional data will reduce model uncertainty.

```{r out.width=600}
# knitr::include_graphics(here::here("inst", "www", "survivalSummary.png" ))
# knitr::include_graphics(here::here("inst", "www", "recruitmentSummary.png" ))
knitr::include_graphics(here::here("vignettes/snapshots", paste0("full_results_", lang, ".png" )))
```

-   Below the population graph is a table summarizing the demographic rates from the current scenario and the projected number of years until the estimated population size reaches less than 10 females. This is considered the quasi-extinction threshold, meaning if there are fewer than 10 females the population will not be able to recover @eccc2011.
-   Below the table is a bar graph showing the % female mortality and the female replacement rate. The coloured bars show the mean % female mortality and female replacement rate in each scenario across the plausible trajectories. The error bars show the minimum and maximum expected values given the uncertainty in the population parameters.
-   A population is considered stable or increasing when the female replacement rate is equal to or greater than % female mortality, meaning that the number of female calves joining the population is larger than the number of adult females dying each year.

The exciting thing that this app allows you to do is explore “what if” scenarios to see how changing female survival and/or calf recruitment rates could affect how populations grow or decline. Click the “Add alternative scenario” button and fill in a descriptive name for the scenario.  For example, if you want to increase female survival to 85% and keep recruitment the same, you can write: 85% Fem 24% Calv. This simple way of naming scenarios will allow you to compare them more easily. Move the survival slider from 74% to 85% and leave the recruitment slider at 24 and click “Run model”. The app will add the updated results to the graphs and tables, showing them in a different colour than the original scenario. You can create several other scenarios with different female survival rates and calf recruitment rates until you find values that cause the population to stabilize or increase. For example, try a survival rate of 85% and a recruitment rate of 35%, and another with a survival rate of 90% and a recruitment rate of 24% and 35%, and see how the curve changes. This will allow you to determine which combinations of survival and recruitment rates would be necessary to stabilize or increase the population. 

This tab also includes a glossary of terms as well as frequently asked questions.

```{r out.width=600}
knitr::include_graphics(here::here("vignettes/snapshots", paste0("alt_results_", lang, ".png" )))
```

## How to Change or Update Data

There are two ways to install the app:

1.  downloading a version of the app that is bundled with all the software needed to run it and the caribou data, (See the [Releases page](https://github.com/LandSciTech/CaribouDemographyBasicApp/releases)) or
2.  installing the R package in your own version of R through the R console (See the [installation instructions](https://github.com/LandSciTech/CaribouDemographyBasicApp?tab=readme-ov-file#installation) for more details).

Only users who installed the R package through the R console, rather than using the bundled version, can modify the data included in the app.

The app uses caribou survival and recruitment data stored in a Google Sheet to calculate the demographic rates. This allows multiple users to collaborate on editing the data. This data is downloaded and used to fit the Bayesian models of survival and recruitment and the results are stored in the R package so that the models do not need to be re-fit every time the app is used.

To change the data used in the app, follow these steps:

1.  Create a Google spreadsheet for your survey data. The spreadsheet must follow the format used by [bboutools](https://poissonconsulting.github.io/bboutools/articles/bboutools.html#providing-data). You can copy this [template Google Sheet](https://docs.google.com/spreadsheets/d/1i53nQrJXgrq3B6jO0ATHhSIbibtLq5TmmFL-PxGQNm8/edit?usp=sharing) and fill it in with your own data. Note that the "population_estimates" and "data_description" tabs are not included in the bboutools example. The "population_estimates" tab provides an estimate of the female population size that will be used as a starting point for simulations. For each population provide a lower and upper bound of the estimated female population. If more than one year of population estimates is provided, only the most recent one will be used. The "data_description" tab provides a space to describe the data that is reported in the other sheets in multiple languages. You can format the text in the description using the Markdown language, see [here](https://www.markdownguide.org/cheat-sheet/) for a cheat-sheet about this format.

2.  Share your Google Sheet so that it can be accessed in the app. Click the Share button in the top right of the Sheet. Then either give access to individual email accounts you want to be able to access the data or set the access to “Anyone with the link” can view the Sheet. Copy the link to share the Sheet.

3.  In the app, click on the "Update Data" button, paste your link in the URL text box, and click "Update"

4.  If necessary, you will be prompted to follow instructions to allow the app access to your Google Drive account. To avoid this you can change the settings on the Google Sheet to allow "Anyone with the link" to view your spreadsheet.

5.  Wait while the model is re-fit, this could take \~ 5 mins.

6.  The app will automatically update the demographic rates and projections based on the new data.

## Technical Details of Model Fitting {#technical-details}

The app utilizes the [`bboutools`](https://poissonconsulting.github.io/bboutools/articles/bboutools.html) package to fit Bayesian models to caribou demographic data [@dalgarno2025]. `bboutools` fits Bayesian models of annual recruitment and survival using generalized linear mixed-effects models where year is treated as a random effect if there is data from more than 5 years. The parameters needed to inform the demographic projections are extracted from these models. The parameters extracted include the mean, standard deviation and 95% credible interval and also the interannual variation in these parameters. It is necessary to extract the parameters from the model rather than using the model directly so that the parameters can be modified to reflect alternative scenarios. These models are only run when the data is updated and the resulting rates are stored in the app and used to make projections.

The demographic rates for the population and the expected variation in them are then used to populate the app for the "Current" scenario and to project the expected female population over the next 20 years. The projected population growth is determined for 35 example trajectories with demographic rates sampled from the normal distribution based on the mean and standard deviation of the rate. Then [`caribouMetrics::caribouPopGrowth()`](https://landscitech.github.io/caribouMetrics/reference/caribouPopGrowth.html) is used to run a two-stage demographic model which projects the growth of the population over 20 years. In addition, a version of the demographic model is run based on the mean demographic rates, and ignoring interannual variation, to produce the mean estimate of the population trajectory over time.

This demographic model is re-run anytime that "Run model" is clicked which will change the resulting graphs slightly since some parts of the model include random values. If an alternative scenario is added the same model is run with the provided demographic rates to project the population under that scenario.

# References
