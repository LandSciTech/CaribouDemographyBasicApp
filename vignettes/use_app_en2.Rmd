---
title: "Using the app"
output: 
  bookdown::html_document2:
      base_format: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Using the app}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
  markdown: 
    wrap: sentence
bibliography: references.bib
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  echo = FALSE,
  message = FALSE, 
  warning = FALSE,
  comment = "#>"
)
```

```{r setup}
library(CaribouDemographyBasicApp)
lang <- "en2"
```

```{=html}
<!--- 
A vignette to outline the uses of the app including: General description of the interface Uncertainty
How to update data
Technical write up on how models are fit that refers back to bboutools/caribouMetrics --->
```

# Using the app

The **Boreal Caribou Population Change Explorer App** helps you explore what might happen to boreal caribou populations over time.
It shows possible future trends – whether caribou numbers might go up, down, or stay about the same – based on the information we have right now.
Among other things, this app lets you see how many caribou survive each year and how many calves (baby caribou) are born and survive to the winter survey.
Note: This app is still in the prototype stage and will be improved in the coming months.

The app uses methods from the “bboutools” and “caribouMetrics” R packages.
These methods rely on data from field surveys.
Female caribou (cows) are fitted with GPS collars to track their survival.
Recruitment is measured by counting calves per 100 females about nine months after calving.
These pieces of information are combined to estimate how the population changes over time.

## Typical app usage

Most users will open the app with caribou population data already loaded.

The **Welcome tab** explains what the app consists of and what it does.
You can choose your language (French or English and a plain language version) and set options used in the Results tab.

The **Survey Data tab** shows the information used to estimate female survival and calf recruitment. It includes five sections: 

  -   A **Description of the data** with a map showing the caribou populations and a list of the survey reports the data comes from.
You can expand this section to full screen for easier reading by clicking on the expand button at the lower right side of the window.
  -   A **Disclaimer** from the creators of the app.
  -   The **Survey Data Summary** section with graphs showing how many caribou were collared and of these, how many died (used to calculate female survival).
And the number of caribou counted during the annual winter survey.
These figures should not be compared directly from one year to the next because the survey area (within a population) is not the same.These values are used by the model to estimate the ratios of males to females and females to calves in the population (used to calculate recruitment).  
    You can switch between the survival and recruitment data graphs by clicking the button in the top right of the section.

  -   The **Demographic Rate Estimates** section showing the estimated female survival and calf recruitment for each year.
Recruitment is measure in terms of the ration of the number of calves per 100 females.
In these charts, each point is the average value, and the lines extending from the point show the range of possible values.

  -   The **Data Summary table** showing the size of the starting female population used to create the possible outcomes, the year that population size was recorded, and how many years of survival and recruitment data are available.

If only one year of survival or recruitment data is available, no results will be displayed because a single year does not provide enough information for a reliable forecast.
```{r out.width=600}
# knitr::include_graphics(here::here("inst", "www", "survivalSummary.png" ))
# knitr::include_graphics(here::here("inst", "www", "recruitmentSummary.png" ))
knitr::include_graphics(here::here("vignettes/snapshots", paste0("input_data_", lang, ".png" )))
```

The **Results tab** shows how the population may change over time based on available data. In the sidebar, you can select a population and the number of years to run the model, then click “Run model.” 

The main graph shows the predicted number of adult females over time. The thick line shows the average prediction, ignoring any uncertainty in the data. The lighter lines show other possible results due to uncertainty in the data. 

Only the female population is shown because it is assumed that the number of females is what limits population growth. A population is stable or increasing if the line is flat or rising, and declining if it slopes downward. Adding additional data will reduce uncertainty in the model. Note: Not all sources of uncertainty about the future are included in this model. Future changes in landscape and climate will impact caribou, but these changes are not accounted for. This simple model illustrates possible futures if conditions remain the same for caribou.


```{r out.width=600}
# knitr::include_graphics(here::here("inst", "www", "survivalSummary.png" ))
# knitr::include_graphics(here::here("inst", "www", "recruitmentSummary.png" ))
knitr::include_graphics(here::here("vignettes/snapshots", paste0("full_results_", lang, ".png" )))
```

A table below the graph shows the model estimated rates (calf recruitment and female survival) and how long it may take for the population to fall below 10 females. This is considered the quasi-extinction threshold: a point where the population is unlikely to recover (according to @eccc2011).

A bar graph below the table shows % female mortality and the female replacement rate (how many new female calves join the population). The coloured bars show the average value, and the lines show the range of possible values considering uncertainty in the data. A population grows or stays stable when the female replacement rate is equal to or higher than the female mortality. For example, if the initial population of females was 100 individuals and the survival rate was 74%, this would mean that 74 females would have survived at the beginning of the year (winter survey) and 26 would have died. If the recruitment rate was 24%, this would mean that there was an average of 24 calves per 100 females. Since half of these calves would be female, only 12 female calves would join the population, which is not enough to replace the 26 females that died. This is why there is a decline. According to these same rates, if there were 500 females at the outset, 370 would have survived, 130 would have died, and only 60 female calves would have been added to the population. These numbers are not enough to stabilize or increase the size of the population. 

The exciting thing that this app allows you to do is explore “what if” scenarios to see how changing female survival and/or calf recruitment rates could affect how populations grow or decline. Click the “Add alternative scenario” button and fill in a descriptive name for the scenario.  For example, if you want to increase female survival to 85% and keep recruitment the same, you can write: 85% Fem 24% Calv. This simple way of naming scenarios will allow you to compare them more easily. Move the survival slider from 74% to 85% and leave the recruitment slider at 24 and click “Run model”. The app will add the updated results to the graphs and tables, showing them in a different colour than the original scenario. You can create several other scenarios with different female survival rates and calf recruitment rates until you find values that cause the population to stabilize or increase. For example, try a survival rate of 85% and a recruitment rate of 35%, and another with a survival rate of 90% and a recruitment rate of 24% and 35%, and see how the curve changes. This will allow you to determine which combinations of survival and recruitment rates would be necessary to stabilize or increase the population. 


```{r out.width=600}
knitr::include_graphics(here::here("vignettes/snapshots", paste0("alt_results_", lang, ".png" )))
```

In this example, one way to stabilize the population is to increase female survival. It must be at least 85% to stabilize the population, but 90% for it to increase. By increasing female survival to 90% and calf recruitment to 35%, female mortality is reduced and the female replacement rate (by female calves) is increased enough for the population to grow and eventually allow a gradual return to sustainability.

You could then talk with people to figure out if these numbers make sense in real life and what your community could do to help, like closing roads, controlling predators, or not harvesting females.

This tab also includes a glossary and FAQs.


## How to Change or Update Data

First, you need to install the app. There are two ways to do so: 

1.  Downloading a version of the app that is bundled with all the software needed to run it and the caribou data, (See the [Releases page](https://github.com/LandSciTech/CaribouDemographyBasicApp/releases)) or 
2.  Installing the R package in your own version of R through the R console (See the [installation instructions](https://github.com/LandSciTech/CaribouDemographyBasicApp?tab=readme-ov-file#installation) for more details).

Only users who installed the R package through the R console, rather than using the bundled version, can modify the data included in the app.

The app uses caribou survival and recruitment data stored in a Google Sheet to calculate the demographic rates. This allows multiple users to collaborate on editing the data. This data is downloaded and used to fit the Bayesian models of survival and recruitment and the results are stored in the R package so that the models do not need to be re-fit every time the app is used.

**To change the data used in the app, follow these steps:**

1.  **Create a Google spreadsheet for your survey data.** The spreadsheet must follow the format used by [bboutools](https://poissonconsulting.github.io/bboutools/articles/bboutools.html#providing-data). You can copy this [template Google Sheet](https://docs.google.com/spreadsheets/d/1i53nQrJXgrq3B6jO0ATHhSIbibtLq5TmmFL-PxGQNm8/edit?usp=sharing) and fill it in with your own data and then save it (“make a copy”) on a Google drive. Regarding the “recruit_data” tab, if you don't have specific dates to report you can set any arbitrary date before April 1 The “recruit_data” and “surv_data” are used by bboutools to estimate survival and recruitment rates.   To project change in population size over time, these rates are combined with an estimate of initial female population size provided in the "population_estimates" tab. For each population provide a lower and upper bound of the estimated female population. If more than one year of population estimates is provided, only the most recent one will be used. The "data_description" tab provides a space to describe the data that is reported in the other sheets in multiple languages. You can format the text in the description using the Markdown language, see [here](https://www.markdownguide.org/cheat-sheet/) for a cheat-sheet about this format.

2.  **Share your Google Sheet so that it can be accessed in the app.** Click the Share button in the top right of the Sheet. Then either give access to individual email accounts you want to be able to access the data or set the access to “Anyone with the link” can view the Sheet. Copy the link to share the Sheet.
3.  In the app, **click on the "Update Data" button, paste your link in the URL text box, and click "Update".**
4.  If necessary, you will be prompted to follow instructions to allow the app access to your Google Drive account. To avoid this you can change the settings on the Google Sheet to allow "Anyone with the link" to view your spreadsheet.
5.  **Wait while the model is re-fit, this could take \~ 5 mins.**
6.  The app will automatically update the demographic rates and projections based on the new data.


## Technical Details of Model Fitting {#technical-details}

The app uses the [`bboutools`](https://poissonconsulting.github.io/bboutools/articles/bboutools.html) package to estimate survival and recruitment rates from caribou demographic data [@dalgarno2025]. `bboutools` fits Bayesian models of annual recruitment and survival using generalized linear mixed-effects models where year is treated as a random effect if there is data from more than 5 years. 

The parameters needed to inform the demographic projections are extracted from these models. The parameters extracted include the mean, standard deviation and 95% credible interval and also the interannual variation in these parameters. It is necessary to extract the parameters from the model rather than using the model directly so that the parameters can be modified to reflect alternative scenarios. The Bayesian models are only re-estimated when the data is updated. 

The demographic rates for the population and the expected variation in them are then used to populate the app for the "Current" scenario and to project the expected female population over the next 20 years. The projected population growth is determined for 35 example trajectories with demographic rates sampled from the summarized Bayesian model. Then [`caribouMetrics::caribouPopGrowth()`](https://landscitech.github.io/caribouMetrics/reference/caribouPopGrowth.html) is used to run a  demographic model that projects the growth of the population over 20 years. 

The demographic model is re-run anytime that "Run model" is clicked which will change the resulting graphs slightly since some parts of the model include random values. If an alternative scenario is added the same model is run with the provided demographic rates to project the population under that scenario.

# References
